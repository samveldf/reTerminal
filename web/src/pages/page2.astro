---
import dayjs from 'dayjs';
import BaseLayout from '../layouts/BaseLayout.astro';
import { getGadgetBriefs } from '../services/newsService';

const { briefs } = await getGadgetBriefs();
const now = dayjs();
---

<BaseLayout>
  <main class="epaper-screen page2-screen">
    <header class="cyber-header">
      <div class="header-title">PAGE 2 // KEY GADGET BRIEFS</div>
      <div class="header-time">{`UPDATED ${now.format('MM-DD HH:mm')}`}</div>
    </header>

    <section class="panel briefs-panel">
      <div class="brief-list">
        {
          briefs.map((brief, idx) => (
            <article class="brief-card">
              <div class="brief-meta">
                <span class="brief-index">{`#${idx + 1}`}</span>
                <span class="brief-source">{brief.source || 'Google News'}</span>
                <span class="brief-time">{brief.pubDate ? dayjs(brief.pubDate).format('MM-DD HH:mm') : '--'}</span>
              </div>
              <h2 class="brief-title">{brief.title}</h2>
              <p class="brief-summary" data-brief-summary>{brief.summary}</p>
            </article>
          ))
        }
      </div>
      <div class="meta-tag">3 BRIEFS / ~200 CHARS EACH</div>
    </section>

    <div class="corner-note">2 / 3</div>
  </main>

  <script is:inline>
    const fitBriefSummaries = () => {
      const summaries = document.querySelectorAll('[data-brief-summary]');
      summaries.forEach((summary) => {
        let size = 14;
        const min = 10;

        const apply = () => {
          summary.style.fontSize = `${size}px`;
          summary.style.lineHeight = `${Math.round(size * 1.25)}px`;
        };

        apply();
        while (size > min && summary.scrollHeight > summary.clientHeight) {
          size -= 1;
          apply();
        }
      });
    };

    window.addEventListener('load', fitBriefSummaries);
    if (document.fonts?.ready) {
      document.fonts.ready.then(() => setTimeout(fitBriefSummaries, 50));
    }
    setTimeout(fitBriefSummaries, 120);
  </script>
</BaseLayout>

<style>
  .page2-screen {
    padding: 6px;
    position: relative;
    gap: 6px;
  }

  .briefs-panel {
    flex: 1;
    min-height: 0;
    border-color: var(--warn);
    padding: 6px;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .brief-list {
    flex: 1;
    min-height: 0;
    display: grid;
    grid-template-rows: repeat(3, 1fr);
    gap: 4px;
  }

  .brief-card {
    border: 1px solid var(--line);
    padding: 4px 6px;
    background: #ffffff;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .brief-card:nth-child(2) {
    border-color: var(--warn);
  }

  .brief-meta {
    height: 14px;
    display: grid;
    grid-template-columns: 24px 1fr auto;
    align-items: center;
    column-gap: 6px;
    line-height: 14px;
  }

  .brief-index {
    color: var(--accent);
    font-size: 11px;
    font-weight: 800;
  }

  .brief-source {
    color: var(--accent);
    font-size: 11px;
    font-weight: 700;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .brief-time {
    color: var(--muted);
    font-size: 11px;
    font-weight: 700;
  }

  .brief-title {
    margin: 0;
    font-size: 16px;
    line-height: 18px;
    color: var(--line);
    font-weight: 800;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .brief-summary {
    margin: 0;
    font-size: 14px;
    line-height: 18px;
    color: var(--text);
    font-weight: 600;
    overflow: hidden;
    word-break: break-word;
    white-space: normal;
  }

  .meta-tag {
    height: 16px;
    color: var(--muted);
    font-size: 11px;
    line-height: 16px;
    font-weight: 700;
    text-align: right;
  }

  .corner-note {
    position: absolute;
    right: 8px;
    bottom: 6px;
    color: var(--muted);
    font-size: 15px;
    font-weight: 700;
    background: rgba(255, 255, 255, 0.86);
    border: 1px solid var(--line);
    padding: 1px 6px;
    line-height: 18px;
  }
</style>
