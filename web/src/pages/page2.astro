---
import dayjs from 'dayjs';
import BaseLayout from '../layouts/BaseLayout.astro';
import { getFeaturedArticle } from '../services/newsService';

const featured = await getFeaturedArticle();
const now = dayjs();
---

<BaseLayout>
  <main class="epaper-screen page2-screen">
    <header class="cyber-header">
      <div class="header-title">PAGE 2 // AI GADGET BRIEF</div>
      <div class="header-time">{`UPDATED ${now.format('MM-DD HH:mm')}`}</div>
    </header>

    <section class="panel summary-panel">
      <div class="meta-line">
        <span class="meta-source">{featured.source || 'Google News'}</span>
        <span class="meta-time">{featured.pubDate ? dayjs(featured.pubDate).format('MM-DD HH:mm') : '--'}</span>
      </div>

      <h1 class="article-title">{featured.title}</h1>
      <article class="article-summary" id="summaryBody">{featured.summary}</article>
      <div class="meta-tag">{`AI SUMMARY ${[...featured.summary].length} CHARS`}</div>
    </section>

    <div class="corner-note">2 / 3</div>
  </main>

  <script is:inline>
    const fitSummary = () => {
      const summary = document.getElementById('summaryBody');
      if (!summary) return;

      let size = 28;
      const min = 20;

      const apply = () => {
        summary.style.fontSize = `${size}px`;
        summary.style.lineHeight = `${Math.round(size * 1.28)}px`;
      };

      apply();
      while (size > min && summary.scrollHeight > summary.clientHeight) {
        size -= 1;
        apply();
      }
    };

    window.addEventListener('load', fitSummary);
    if (document.fonts?.ready) {
      document.fonts.ready.then(() => setTimeout(fitSummary, 50));
    }
    setTimeout(fitSummary, 100);
  </script>
</BaseLayout>

<style>
  .page2-screen {
    padding: 6px;
    position: relative;
    gap: 6px;
  }

  .summary-panel {
    flex: 1;
    min-height: 0;
    border-color: var(--warn);
    padding: 6px;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .meta-line {
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 17px;
    line-height: 20px;
    font-weight: 700;
    border-bottom: 1px solid var(--accent);
    padding-bottom: 2px;
  }

  .meta-source {
    color: var(--accent);
    text-transform: uppercase;
    letter-spacing: 0.6px;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
  }

  .meta-time {
    color: var(--muted);
    margin-left: 8px;
  }

  .article-title {
    margin: 0;
    min-height: 50px;
    max-height: 50px;
    overflow: hidden;
    color: #008fa9;
    font-size: 23px;
    font-weight: 800;
    line-height: 24px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
  }

  .article-summary {
    flex: 1;
    min-height: 0;
    overflow: hidden;
    color: var(--text);
    white-space: pre-line;
    word-break: break-word;
    font-size: 22px;
    line-height: 29px;
    font-weight: 600;
    padding-right: 4px;
  }

  .meta-tag {
    height: 18px;
    color: var(--muted);
    font-size: 14px;
    line-height: 16px;
    font-weight: 700;
    text-align: right;
  }

  .corner-note {
    position: absolute;
    right: 8px;
    bottom: 6px;
    color: var(--muted);
    font-size: 15px;
    font-weight: 700;
    background: rgba(255, 255, 255, 0.86);
    border: 1px solid var(--line);
    padding: 1px 6px;
    line-height: 18px;
  }
</style>
