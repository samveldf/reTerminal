---
import dayjs from 'dayjs';
import BaseLayout from '../layouts/BaseLayout.astro';
import { getGadgetBriefs } from '../services/newsService';

const { briefs } = await getGadgetBriefs();
const now = dayjs();
---

<BaseLayout>
  <main class="epaper-screen page2-screen">
    <header class="cyber-header">
      <div class="header-title">PAGE 2 // KEY GADGET BRIEFS</div>
      <div class="header-time">{`UPDATED ${now.format('MM-DD HH:mm')}`}</div>
    </header>

    <section class="panel briefs-panel">
      <div class="brief-list">
        {
          briefs.map((brief, idx) => (
            <article class="brief-card">
              <div class="brief-meta">
                <span class="brief-index">{`#${idx + 1}`}</span>
                <span class="brief-source">{brief.source || 'Google News'}</span>
                <span class="brief-time">{brief.pubDate ? dayjs(brief.pubDate).format('MM-DD HH:mm') : '--'}</span>
              </div>
              <h2 class="brief-title" data-brief-title>{brief.title}</h2>
              <p class="brief-summary" data-brief-summary>{brief.summary}</p>
            </article>
          ))
        }
      </div>
    </section>

    <div class="corner-note">2 / 3</div>
  </main>

  <script is:inline>
    const fitBriefCards = () => {
      const cards = document.querySelectorAll('.brief-card');
      cards.forEach((card) => {
        const title = card.querySelector('[data-brief-title]');
        const summary = card.querySelector('[data-brief-summary]');
        if (!title || !summary) return;

        const fitTitle = () => {
          const min = 15;
          const max = 24;
          let low = min;
          let high = max;
          let best = min;

          const apply = (size) => {
            const lineHeight = Math.round(size * 1.08);
            title.style.fontSize = `${size}px`;
            title.style.lineHeight = `${lineHeight}px`;
            title.style.maxHeight = `${lineHeight * 2}px`;
          };

          while (low <= high) {
            const mid = Math.floor((low + high) / 2);
            apply(mid);
            if (title.scrollHeight <= title.clientHeight + 1) {
              best = mid;
              low = mid + 1;
            } else {
              high = mid - 1;
            }
          }
          apply(best);
        };

        const fitSummary = () => {
          const min = 14;
          const max = 30;
          let low = min;
          let high = max;
          let best = min;

          const apply = (size) => {
            summary.style.fontSize = `${size}px`;
            summary.style.lineHeight = `${Math.round(size * 1.15)}px`;
          };

          while (low <= high) {
            const mid = Math.floor((low + high) / 2);
            apply(mid);
            if (summary.scrollHeight <= summary.clientHeight + 1) {
              best = mid;
              low = mid + 1;
            } else {
              high = mid - 1;
            }
          }
          apply(best);
        };

        fitTitle();
        fitSummary();
      });
    };

    window.addEventListener('load', fitBriefCards);
    if (document.fonts?.ready) {
      document.fonts.ready.then(() => setTimeout(fitBriefCards, 50));
    }
    setTimeout(fitBriefCards, 120);
  </script>
</BaseLayout>

<style>
  .page2-screen {
    padding: 5px;
    position: relative;
    gap: 5px;
  }

  .page2-screen .cyber-header {
    height: 44px;
    padding: 4px 9px;
  }

  .page2-screen .header-title {
    font-size: 22px;
    line-height: 24px;
    letter-spacing: 0.5px;
  }

  .page2-screen .header-time {
    font-size: 16px;
    line-height: 18px;
  }

  .briefs-panel {
    flex: 1;
    min-height: 0;
    border-color: var(--warn);
    padding: 4px;
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .brief-list {
    flex: 1;
    min-height: 0;
    display: grid;
    grid-template-rows: repeat(3, 1fr);
    gap: 1px;
  }

  .brief-card {
    border: 1px solid var(--line);
    padding: 3px 5px;
    background: #ffffff;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .brief-card:nth-child(2) {
    border-color: var(--warn);
  }

  .brief-meta {
    height: 14px;
    display: grid;
    grid-template-columns: 24px 1fr auto;
    align-items: center;
    column-gap: 4px;
    line-height: 14px;
  }

  .brief-index {
    color: var(--accent);
    font-size: 10px;
    font-weight: 800;
  }

  .brief-source {
    color: var(--accent);
    font-size: 10px;
    font-weight: 700;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .brief-time {
    color: var(--muted);
    font-size: 10px;
    font-weight: 700;
  }

  .brief-title {
    margin: 0;
    font-size: 19px;
    line-height: 21px;
    color: var(--line);
    font-weight: 800;
    white-space: normal;
    overflow: hidden;
    text-overflow: clip;
    display: block;
    word-break: break-word;
  }

  .brief-summary {
    margin: 0;
    font-size: 18px;
    line-height: 21px;
    color: var(--text);
    font-weight: 700;
    flex: 1;
    min-height: 0;
    overflow: hidden;
    word-break: break-word;
    white-space: normal;
    text-rendering: geometricPrecision;
  }

  .corner-note {
    position: absolute;
    right: 8px;
    bottom: 6px;
    color: var(--muted);
    font-size: 15px;
    font-weight: 700;
    background: rgba(255, 255, 255, 0.86);
    border: 1px solid var(--line);
    padding: 1px 6px;
    line-height: 18px;
  }
</style>
