---
import dayjs from 'dayjs';
import BaseLayout from '../layouts/BaseLayout.astro';
import { getGadgetBriefs } from '../services/newsService';

const { briefs } = await getGadgetBriefs();
const now = dayjs();
---

<BaseLayout>
  <main class="epaper-screen page2-screen">
    <header class="cyber-header">
      <div class="header-title">PAGE 2 // KEY GADGET BRIEFS</div>
      <div class="header-time">{`UPDATED ${now.format('MM-DD HH:mm')}`}</div>
    </header>

    <section class="panel briefs-panel">
      <div class="brief-list">
        {
          briefs.map((brief, idx) => (
            <article class="brief-card">
              <div class="brief-meta">
                <span class="brief-index">{`#${idx + 1}`}</span>
                <span class="brief-source">{brief.source || 'Google News'}</span>
                <span class="brief-time">{brief.pubDate ? dayjs(brief.pubDate).format('MM-DD HH:mm') : '--'}</span>
              </div>
              <h2 class="brief-title">{brief.title}</h2>
              <p class="brief-summary" data-brief-summary>{brief.summary}</p>
            </article>
          ))
        }
      </div>
    </section>

    <div class="corner-note">2 / 3</div>
  </main>

  <script is:inline>
    const fitBriefSummaries = () => {
      const summaries = document.querySelectorAll('[data-brief-summary]');
      summaries.forEach((summary) => {
        const min = 13;
        const max = 30;
        let low = min;
        let high = max;
        let best = min;

        const apply = (size) => {
          summary.style.fontSize = `${size}px`;
          summary.style.lineHeight = `${Math.round(size * 1.16)}px`;
        };

        while (low <= high) {
          const mid = Math.floor((low + high) / 2);
          apply(mid);
          if (summary.scrollHeight <= summary.clientHeight) {
            best = mid;
            low = mid + 1;
          } else {
            high = mid - 1;
          }
        }

        apply(best);
      });
    };

    window.addEventListener('load', fitBriefSummaries);
    if (document.fonts?.ready) {
      document.fonts.ready.then(() => setTimeout(fitBriefSummaries, 50));
    }
    setTimeout(fitBriefSummaries, 120);
  </script>
</BaseLayout>

<style>
  .page2-screen {
    padding: 5px;
    position: relative;
    gap: 5px;
  }

  .page2-screen .cyber-header {
    height: 44px;
    padding: 4px 9px;
  }

  .page2-screen .header-title {
    font-size: 22px;
    line-height: 24px;
    letter-spacing: 0.5px;
  }

  .page2-screen .header-time {
    font-size: 16px;
    line-height: 18px;
  }

  .briefs-panel {
    flex: 1;
    min-height: 0;
    border-color: var(--warn);
    padding: 4px;
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .brief-list {
    flex: 1;
    min-height: 0;
    display: grid;
    grid-template-rows: repeat(3, 1fr);
    gap: 1px;
  }

  .brief-card {
    border: 1px solid var(--line);
    padding: 3px 5px;
    background: #ffffff;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .brief-card:nth-child(2) {
    border-color: var(--warn);
  }

  .brief-meta {
    height: 13px;
    display: grid;
    grid-template-columns: 24px 1fr auto;
    align-items: center;
    column-gap: 4px;
    line-height: 13px;
  }

  .brief-index {
    color: var(--accent);
    font-size: 10px;
    font-weight: 800;
  }

  .brief-source {
    color: var(--accent);
    font-size: 10px;
    font-weight: 700;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .brief-time {
    color: var(--muted);
    font-size: 10px;
    font-weight: 700;
  }

  .brief-title {
    margin: 0;
    font-size: 20px;
    line-height: 21px;
    color: var(--line);
    font-weight: 800;
    white-space: normal;
    overflow: hidden;
    text-overflow: clip;
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
  }

  .brief-summary {
    margin: 0;
    font-size: 18px;
    line-height: 21px;
    color: var(--text);
    font-weight: 700;
    flex: 1;
    min-height: 0;
    overflow: hidden;
    word-break: break-word;
    white-space: normal;
    text-rendering: geometricPrecision;
  }

  .corner-note {
    position: absolute;
    right: 8px;
    bottom: 6px;
    color: var(--muted);
    font-size: 15px;
    font-weight: 700;
    background: rgba(255, 255, 255, 0.86);
    border: 1px solid var(--line);
    padding: 1px 6px;
    line-height: 18px;
  }
</style>
