---
import dayjs from 'dayjs';
import BaseLayout from '../layouts/BaseLayout.astro';
import { getFeaturedArticle } from '../services/newsService';

const featured = await getFeaturedArticle();
const now = dayjs();
---

<BaseLayout>
  <main class="epaper-screen page2-screen">
    <header class="cyber-header">
      <div class="header-title">PAGE 2 // FEATURED FULL TEXT</div>
      <div class="header-time">{`UPDATED ${now.format('MM-DD HH:mm')}`}</div>
    </header>

    <section class="panel fulltext-panel">
      <div class="meta-line">
        <span class="meta-source">{featured.source || 'Google News'}</span>
        <span class="meta-time">{featured.pubDate ? dayjs(featured.pubDate).format('MM-DD HH:mm') : '--'}</span>
      </div>

      <h1 class="article-title">{featured.title}</h1>
      <article class="article-body" id="articleBody">{featured.body}</article>
    </section>

    <div class="corner-note">2 / 3</div>
  </main>

  <script is:inline>
    const fitArticle = () => {
      const body = document.getElementById('articleBody');
      if (!body) return;

      let size = 22;
      const min = 7;

      const apply = () => {
        body.style.fontSize = `${size}px`;
        body.style.lineHeight = `${Math.max(8, Math.round(size * 1.3))}px`;
      };

      apply();
      while (size > min && body.scrollHeight > body.clientHeight) {
        size -= 1;
        apply();
      }

      if (body.scrollHeight > body.clientHeight) {
        body.style.letterSpacing = '-0.15px';
        while (size > 6 && body.scrollHeight > body.clientHeight) {
          size -= 1;
          apply();
        }
      }
    };

    window.addEventListener('load', fitArticle);
    if (document.fonts?.ready) {
      document.fonts.ready.then(() => setTimeout(fitArticle, 50));
    }
    setTimeout(fitArticle, 120);
  </script>
</BaseLayout>

<style>
  .page2-screen {
    padding: 6px;
    position: relative;
    gap: 6px;
  }

  .fulltext-panel {
    flex: 1;
    min-height: 0;
    border-color: var(--warn);
    padding: 6px;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .meta-line {
    height: 18px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 12px;
    line-height: 14px;
    font-weight: 700;
    border-bottom: 1px solid var(--accent);
    padding-bottom: 2px;
  }

  .meta-source {
    color: var(--accent);
    text-transform: uppercase;
    letter-spacing: 1px;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
  }

  .meta-time {
    color: var(--muted);
    margin-left: 8px;
  }

  .article-title {
    margin: 0;
    min-height: 46px;
    max-height: 46px;
    overflow: hidden;
    color: var(--accent);
    font-size: 18px;
    font-weight: 800;
    line-height: 22px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
  }

  .article-body {
    flex: 1;
    min-height: 0;
    overflow: hidden;
    color: var(--text);
    white-space: pre-line;
    word-break: break-word;
    font-size: 16px;
    line-height: 22px;
  }

  .corner-note {
    position: absolute;
    right: 8px;
    bottom: 6px;
    color: var(--muted);
    font-size: 12px;
    font-weight: 700;
    background: rgba(5, 7, 10, 0.6);
    border: 1px solid var(--line);
    padding: 1px 6px;
    line-height: 16px;
  }
</style>
